import _ from 'lodash';
import validateArgs from '../common/validate-args';

// Each new term in the Fibonacci sequence is generated by adding the previous two terms. 
// By starting with 1 and 2, the first 10 terms will be:

// 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, ...

// By considering the terms in the Fibonacci sequence whose values do not exceed 
// four million, find the sum of the even-valued terms.

// for purposes of problem assuming 4m

  const validateAndExec = validateArgs((args) => {
  return (
    args &&
    typeof args === 'object' &&
    args.max &&
    typeof args.max === 'number' &&
    args.max > 1
  );
});

export default function solution(args = { max: 4000000 }) {
  return sumOfAllEvenFibs(args);
};

export function sumOfAllEvenFibs(args) {
  return validateAndExec(_sumOfAllEvenFibs, args)
}

function _sumOfAllEvenFibs(args) {
  const {
    count = 0,
    max = 0
  } = args;

  return count < max ? 
    _sumOfAllEvenFibs(update(args)) :
    count;
}

function nextFib(prev = 0, current = 1) {
  return prev + current;
}

function update(args) {
  return updateCount(updateCurrentAndPrevious(args));
}

function updateCount(args) {
  const current = args.current;
  const count = args.count || 0;
  const newCount = 
    isEven(current) ?
      count + current :
      count;

  return {
    ...args,
    count: newCount
  };
}

function updateCurrentAndPrevious(args) {
  return {
    ...args,
    current: nextFib(args.previous, args.current),
    previous: args.current
  };
}


function isEven(num) {
  return num % 2 === 0;
}
